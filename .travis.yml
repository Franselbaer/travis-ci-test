sudo: required

services:
  - docker

language: python

install:
  - sudo apt-get update >/dev/null 2>&1
  - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-ce >/dev/null 2>&1

script:
  - docker build -t helloworld:test .
  - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
  - docker tag helloworld:test $DOCKER_USERNAME/helloworld:test
  - docker push $DOCKER_USERNAME/helloworld:test
  - docker run --rm $DOCKER_USERNAME/helloworld:test

after_success:
  - echo $TRAVIS_BRANCH
  - test $TRAVIS_BRANCH = "master" &&
    docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
    docker tag helloworld:stage $DOCKER_USERNAME/helloworld:latest
    docker push $DOCKER_USERNAME/helloworld:latest
  - test $TRAVIS_BRANCH = "stage" &&
    docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
    docker tag helloworld:stage $DOCKER_USERNAME/helloworld:stage
    docker push $DOCKER_USERNAME/helloworld:stage
